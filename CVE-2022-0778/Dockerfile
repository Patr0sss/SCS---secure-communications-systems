FROM ubuntu:20.04

RUN apt-get update && apt-get install -y \
    wget \
    build-essential \
    libpcre3-dev \
    zlib1g-dev

# Vulnerable OpenSSL 3.0.1 version
RUN wget https://www.openssl.org/source/openssl-3.0.1.tar.gz && \
    tar -xvf openssl-3.0.1.tar.gz && \
    cd openssl-3.0.1 && \
    ./config && \
    make && \
    make install

# Inform the system where the new OpenSSL libraries are located and update the cache
RUN echo "/usr/local/lib64" > /etc/ld.so.conf.d/openssl.conf && ldconfig

# Download and build Nginx with the vulnerable OpenSSL version
RUN wget http://nginx.org/download/nginx-1.21.6.tar.gz && \
    tar -zxvf nginx-1.21.6.tar.gz && \
    cd nginx-1.21.6 && \
    ./configure --with-http_ssl_module --with-openssl=../openssl-3.0.1 && \
    make && \
    make install

# Generate a self-signed certificate for testing
RUN mkdir -p /usr/local/nginx/conf/ssl && \
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /usr/local/nginx/conf/ssl/nginx.key \
    -out /usr/local/nginx/conf/ssl/nginx.crt \
    -subj "/C=PL/ST=Mazowieckie/L=Warszawa/O=Test/CN=localhost"

# Copy custom Nginx configuration to enable SSL
COPY nginx.conf /usr/local/nginx/conf/nginx.conf

EXPOSE 443

CMD ["/usr/local/nginx/sbin/nginx", "-g", "daemon off;"]